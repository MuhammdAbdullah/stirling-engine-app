name: Build for Raspberry Pi

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-arm64:
    name: Build ARM64 (Pi 3/4/5)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU for ARM64
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libudev-dev build-essential

      - name: Install dependencies
        run: npm install
        env:
          npm_config_arch: arm64

      - name: Rebuild native modules for ARM64
        run: |
          npm rebuild serialport --target_arch=arm64

      - name: Build for ARM64
        run: npm run build-linux-arm64
        env:
          npm_config_arch: arm64

      - name: Upload ARM64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: raspberry-pi-arm64
          path: dist/*.AppImage
          retention-days: 30

  build-armv7l:
    name: Build ARMv7 (Pi 1/2/Zero)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU for ARMv7
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libudev-dev build-essential

      - name: Install dependencies
        run: npm install
        env:
          npm_config_arch: armv7l

      - name: Rebuild native modules for ARMv7
        run: |
          npm rebuild serialport --target_arch=armv7l

      - name: Build for ARMv7l
        run: npm run build-linux-armv7l
        env:
          npm_config_arch: armv7l

      - name: Upload ARMv7l artifacts
        uses: actions/upload-artifact@v4
        with:
          name: raspberry-pi-armv7l
          path: dist/*.AppImage
          retention-days: 30
          
   create-release:
     name: Create Release with Builds
     needs: [build-arm64, build-armv7l]
     runs-on: ubuntu-latest
     if: github.ref == 'refs/heads/main'
     permissions:
       contents: write
     steps:

      - name: Download ARM64 artifacts
        uses: actions/download-artifact@v4
        with:
          name: raspberry-pi-arm64
          path: ./artifacts/arm64

      - name: Download ARMv7l artifacts
        uses: actions/download-artifact@v4
        with:
          name: raspberry-pi-armv7l
          path: ./artifacts/armv7l

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ./artifacts/arm64/*
            ./artifacts/armv7l/*
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }} - Raspberry Pi Builds
          body: |
            Pre-built executables for Raspberry Pi
            
            **ARM64** (Raspberry Pi 3, 4, 5):
            - Download the AppImage file
            - Make it executable: `chmod +x "Matrix Stirling Engine-"*.AppImage`
            - Run: `./"Matrix Stirling Engine-"*.AppImage`
            
            **ARMv7** (Raspberry Pi 1, 2, Zero):
            - Download the AppImage file
            - Make it executable: `chmod +x "Matrix Stirling Engine-"*.AppImage`
            - Run: `./"Matrix Stirling Engine-"*.AppImage`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

